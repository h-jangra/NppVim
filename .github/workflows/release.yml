name: NppVim Release

on:
  push:
    tags:
      - "*.*.*.*"

permissions:
  contents: write

env:
  BUILD_TYPE: Release
  BUILD_DIR: build/x64
  DIST_DIR: dist/NppVim.x64
  PLUGIN_NAME: NppVim

jobs:
  build:
    runs-on: windows-latest

    strategy:
      matrix:
        arch:
          - name: win32
            cmake_arch: Win32
            build_dir: build/win32
            dist_dir: dist/NppVim
            suffix: x86
          - name: x64
            cmake_arch: x64
            build_dir: build/x64
            dist_dir: dist/NppVim.x64
            suffix: x64


    steps:
    - uses: actions/checkout@v4

    - name: Validate version
      shell: powershell
      run: |
        $rc = Get-Content "plugin/NppVim.rc"
        $line = $rc | Where-Object { $_ -match "FILEVERSION" } | Select-Object -First 1
        if (!$line) { Write-Error "FILEVERSION not found"; exit 1 }
        $version = ($line -replace "[^\d,]", "") -replace ",", "."
        $tag = "${{ github.ref_name }}"
        echo "RC_VERSION=$version" >> $env:GITHUB_ENV
        if ($version -ne $tag) {
          Write-Error "Version mismatch: RC=$version TAG=$tag"
          exit 1
        }

    - name: Setup CMake
      uses: lukka/get-cmake@v3.30.0

    - name: Setup MSVC Compiler
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: ${{ matrix.arch.name }}

    - name: Configure
      run: >
        cmake
        -S .
        -B ${{ matrix.arch.build_dir }}
        -G Ninja
        -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
        -DDIST_DIR=${{ matrix.arch.dist_dir }}

    - name: Build
      run: >
        cmake
        --build ${{ matrix.arch.build_dir }}
        --config ${{ env.BUILD_TYPE }}

    - name: Verify dist output
      shell: powershell
      run: |
        if (!(Test-Path "${{ matrix.arch.dist_dir }}")) {
          Write-Error "Dist folder not found: ${{ matrix.arch.dist_dir }}"
          exit 1
        }
        Get-ChildItem "${{ matrix.arch.dist_dir }}"

    - name: Archive
      uses: thedoctor0/zip-release@0.7.6
      with:
        type: zip
        filename: ${{ env.PLUGIN_NAME }}-${{ github.ref_name }}-${{ matrix.arch.suffix }}.zip
        directory: ${{ matrix.arch.dist_dir }}

    - name: Create Release / Upload
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        name: NppVim ${{ github.ref_name }}
        generate_release_notes: true
        files: ${{ matrix.arch.dist_dir }}/${{ env.PLUGIN_NAME }}-${{ github.ref_name }}-${{ matrix.arch.suffix }}.zip

    - name: SHA256
      shell: bash
      run: |
          FILE="${{ github.workspace }}/${{ matrix.arch.dist_dir }}/${{ env.PLUGIN_NAME }}-${{ github.ref_name }}-${{ matrix.arch.suffix }}.zip"
          sha256sum.exe "$FILE"
